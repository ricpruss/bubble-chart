<!DOCTYPE html>
<html>
<head>
    <title>Test Key Function Streaming Fix</title>
    <script src="../../dist/bubble-chart.min.js"></script>
    <style>
        #chart { width: 800px; height: 600px; border: 1px solid #ccc; }
        .controls { margin: 20px 0; }
        button { margin: 5px; padding: 10px; }
    </style>
</head>
<body>
    <h1>Test Key Function Streaming Fix</h1>
    <div id="chart"></div>
    <div class="controls">
        <button onclick="addRandomData()">Add Random Item</button>
        <button onclick="updateExistingItem()">Update Existing Item</button>
        <button onclick="removeRandomItem()">Remove Random Item</button>
        <button onclick="showDebugInfo()">Show Debug Info</button>
    </div>
    <div id="debug"></div>

    <script>
        // Create initial data with custom ID field
        const initialData = [
            { customId: 'item-1', name: 'Alice', value: 30, color: 'red' },
            { customId: 'item-2', name: 'Bob', value: 45, color: 'blue' },
            { customId: 'item-3', name: 'Charlie', value: 20, color: 'green' }
        ];

        // Create chart with custom key function using customId field
        const chart = BubbleChart
            .create('#chart')
            .withData(initialData)
            .withLabel('name')
            .withSize('value')
            .withColor('color')
            .withAnimations('gentle')
            .withStreaming({
                keyFunction: (d) => d.customId, // Custom key function
                enterAnimation: { duration: 1000, staggerDelay: 100, easing: 'ease-out' },
                updateAnimation: { duration: 800, easing: 'ease-in-out' },
                exitAnimation: { duration: 600, easing: 'ease-in' }
            })
            .render();

        // Move itemCounter declaration before functions
        let itemCounter = 4;

        function addRandomData() {
            const newItem = {
                customId: `item-${itemCounter++}`,
                name: `Person ${itemCounter - 1}`,
                value: Math.random() * 50 + 10,
                color: ['red', 'blue', 'green', 'orange', 'purple'][Math.floor(Math.random() * 5)]
            };
            
            console.log('Adding item:', newItem);
            chart.store.add(newItem);
            updateDebugInfo();
        }

        function updateExistingItem() {
            const items = chart.store.data();
            if (items.length > 0) {
                const randomItem = items[Math.floor(Math.random() * items.length)];
                const newValue = Math.random() * 50 + 10;
                
                console.log('Updating item:', randomItem.customId, 'new value:', newValue);
                chart.store.update(randomItem.customId, { value: newValue });
                updateDebugInfo();
            }
        }

        function removeRandomItem() {
            const items = chart.store.data();
            if (items.length > 1) { // Keep at least one item
                const randomItem = items[Math.floor(Math.random() * items.length)];
                
                console.log('Removing item:', randomItem.customId);
                chart.store.remove(randomItem.customId);
                updateDebugInfo();
            }
        }

        function showDebugInfo() {
            updateDebugInfo();
        }

        function updateDebugInfo() {
            const items = chart.store.data();
            const keys = chart.store.keys();
            
            const debugInfo = `
                <h3>Debug Information</h3>
                <p><strong>Total items:</strong> ${items.length}</p>
                <p><strong>Keys:</strong> ${keys.join(', ')}</p>
                <p><strong>Items:</strong></p>
                <ul>
                    ${items.map(item => `<li>${item.customId}: ${item.name} (value: ${item.value})</li>`).join('')}
                </ul>
            `;
            
            document.getElementById('debug').innerHTML = debugInfo;
        }

        // Register change listener to log streaming updates
        chart.on('change', (stats) => {
            console.log('Chart changed:', stats);
            console.log('- Entered:', stats.entered);
            console.log('- Updated:', stats.updated);
            console.log('- Exited:', stats.exited);
            console.log('- Total:', stats.total);
        });

        // Initial debug info
        updateDebugInfo();
    </script>
</body>
</html>
