<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Bubble Tree Timeline</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="../../dist/bubble-chart.min.js"></script>
  <script src="../js/tech-hierarchy.js"></script>
  <style>
    body { font-family: sans-serif; }
    #controls {
      margin: 1rem auto;
      max-width: 900px;
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      justify-content: center;
    }
    .year-btn {
      border: 1px solid #888;
      background: #f5f5f5;
      padding: 0.25rem 0.75rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.95rem;
      user-select: none;
      transition: all 0.15s ease;
    }
    .year-btn:hover { background: #e8e8e8; }
    .year-btn.active {
      background: #4bc0c0;
      color: #fff;
      border-color: #4bc0c0;
    }
    #tree-tl-container { width: 100%; max-width: 900px; height: 600px; margin: auto; }
  </style>
</head>
<body>
  <h1>Bubble Tree â€“ Timeline</h1>

  <!-- Controls (year buttons) -->
  <div id="controls"></div>

  <!-- Chart container -->
  <div id="tree-tl-container"></div>

  <script>

    // ------------------------------------------------------------------
    // Build lookup of min/max years from dataset
    // ------------------------------------------------------------------
            const fullData = window.data; // defined in tech-hierarchy.js (hierarchical)

    function getYearExtent(node, extent = [Infinity, -Infinity]) {
      if (node.year !== undefined) {
        extent[0] = Math.min(extent[0], node.year);
        extent[1] = Math.max(extent[1], node.year);
      }
      if (node.children) node.children.forEach(child => getYearExtent(child, extent));
      return extent;
    }
    const [minYear, maxYear] = getYearExtent(fullData);

    // Build year buttons dynamically
    const controlsDiv = document.getElementById('controls');
    let currentYear = maxYear;

    for (let y = minYear; y <= maxYear; y++) {
      const btn = document.createElement('button');
      btn.textContent = y;
      btn.className = 'year-btn' + (y === currentYear ? ' active' : '');
      btn.addEventListener('click', () => {
        if (currentYear === y) return; // already selected
        currentYear = y;
        updateButtons();
        updateChart(y);
      });
      controlsDiv.appendChild(btn);
    }

    function updateButtons() {
      controlsDiv.querySelectorAll('.year-btn').forEach(btn => {
        btn.classList.toggle('active', +btn.textContent === currentYear);
      });
    }

    // ------------------------------------------------------------------
    // Recursive filter by year (keeps branch if any descendant matches)
    // ------------------------------------------------------------------
    function filterByYear(node, year) {
      if (!node.children) {
        return node.year === undefined || node.year === year ? { ...node } : null;
      }
      const filteredChildren = node.children
        .map(child => filterByYear(child, year))
        .filter(Boolean);
      if (filteredChildren.length === 0 && node.year !== year) return null;
      return { ...node, children: filteredChildren };
    }

    // ------------------------------------------------------------------
    // Chart instance
    // ------------------------------------------------------------------
    let chart = null;

    // Initial render
    updateChart(maxYear);

    function updateChart(year) {
      const filtered = filterByYear(fullData, year);
      
      // Create or update chart with D3-native API
      if (!chart) {
        chart = BubbleChart.create('#tree-tl-container')
          .withData(filtered)
          .withLabel('label')
          .withSize('amount')
          .withColor('name')  // Color by module/category name
          .withType('tree')
          .withAnimations('gentle')
          .render();
      } else {
        // D3-native update: simply call update with new data
        chart.update(filtered);
      }
    }
  </script>
</body>
</html>
