<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reactive Bubble Chart - New API</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <!-- no local dataset; will fetch Fortune-1000 CSV dynamically -->
    <script src="../../dist/bubble-chart.min.js"></script>
    <style>
        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f7fa;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #333;
            margin: 0 0 10px 0;
            font-size: 2.5em;
            font-weight: 300;
        }
        
        .header p {
            color: #666;
            font-size: 1.1em;
            margin: 0;
        }
        
        .demo-section {
            margin: 30px 0;
        }
        
        .demo-section h2 {
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        
        .controls {
            display: flex;
            gap: 12px;
            margin: 15px 0;
        }
        
        .controls button {
            background: #667eea;
            color: #fff;
            border: none;
            padding: 8px 14px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85rem;
        }
        
        .controls button:hover {
            background: #5a67d8;
        }
        
        .controls button:active {
            transform: translateY(0);
        }
        
        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            min-height: 400px;
        }
        
        .status {
            margin-top: 10px;
            color: #555;
            font-size: 0.9rem;
        }
        
        .code-example {
            background: #282c34;
            color: #abb2bf;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
            white-space: pre-line;
            overflow-x: auto;
            margin: 15px 0;
        }
        
        .keyword { color: #c678dd; }
        .string { color: #98c379; }
        .comment { color: #5c6370; font-style: italic; }
        
        .info {
            background: #f8f9ff;
            border-left: 4px solid #667eea;
            padding: 20px;
            border-radius: 0 8px 8px 0;
            margin-top: 20px;
        }
        
        .info h3 {
            margin-top: 0;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎈 Reactive Bubble Chart - New API</h1>
            <p>Demonstrating automatic data updates with reactive patterns</p>
        </div>

        <div class="demo-section">
            <h2>Streaming Data Updates</h2>
            
            <div class="controls">
                <button id="addBtn">Add One</button>
                <button id="add5Btn">Add 5</button>
                <button id="removeBtn">Remove</button>
                <button id="clearBtn">Clear All</button>
            </div>
            
            <div id="status" class="status">Initialised.</div>
            
            <div class="chart-container" id="chart"></div>
        </div>

        <div class="demo-section">
            <h2>Code Example</h2>
            
            <div class="code-example">
<span class="comment">// Old API (deprecated - manual data management)</span>
<span class="keyword">const</span> chart = <span class="keyword">new</span> BubbleChart({
    container: <span class="string">'#chart'</span>,
    label: <span class="string">'name'</span>,
    size: <span class="string">'value'</span>
});
chart.data(newData).update(); <span class="comment">// Manual updates, no streaming</span>

<span class="comment">// Modern D3-Native API (pure D3 patterns with fluent interface)</span>
<span class="keyword">const</span> chart = BubbleChart.create(<span class="string">'#chart'</span>)
    .withLabel(<span class="string">'Company'</span>)
    .withSize(<span class="string">'Revenues_M'</span>)
    .withColor(<span class="string">'Sector'</span>)
    .withAnimations(<span class="string">'gentle'</span>)
    .build();
    
<span class="comment">// D3-native updates - manage data array and update chart</span>
<span class="keyword">let</span> currentData = [];
currentData.push(newCompany);   <span class="comment">// Add to data array</span>
chart.update(currentData);      <span class="comment">// D3-native update with animations</span>
            </div>
            
            <div class="info">
                <h3>📚 Benefits of Streaming Updates</h3>
                <p>
                    • <strong>Smooth Animations:</strong> New bubbles appear with staggered entrance effects<br>
                    • <strong>No Screen Clearing:</strong> Updates happen in-place using D3's enter/update/exit pattern<br>
                    • <strong>Intelligent Layout:</strong> Existing bubbles smoothly transition to new positions<br>
                    • <strong>Visual Continuity:</strong> Users can track individual bubbles through changes<br>
                    • <strong>Performance:</strong> Only changed elements are updated, not the entire chart
                </p>
            </div>
        </div>
    </div>

    <script>
        // Create chart using modern D3-native API
        const chart = BubbleChart.create('#chart')
            .withLabel('Company')
            .withSize('Revenues_M')
            .withColor('Sector')  // Color by sector automatically
            .withDimensions(800, 480)
            .withKey((d) => d.Company) // Use company name as key to avoid screen clearing
            .withAnimations('gentle')  // Smooth animations for data updates
            .build();
        
        // Track current dataset for D3-native updates
        let currentData = [];

        // load local JSON dataset generated by fetch-fortune1000.js
        const jsonUrl='../data/fortune1000.json';
        let all=[];
        let idx=0;

        const statusEl=document.getElementById('status');
        const setStatus=msg=>{ if(statusEl) statusEl.textContent=msg; };

        d3.json(jsonUrl).then(dataArr=>{
            all = dataArr;
            setStatus(`Dataset loaded (${all.length} companies). Click Add to stream.`);
        }).catch(err=>{
            console.error('JSON load error',err);
            setStatus('Failed to load dataset');
        });

        document.getElementById('addBtn').onclick=()=>{
            if(!all.length) return;
            if(idx>=all.length) return;
            const item=all[idx++];
            
            // D3-native update: add item to current data and update chart
            currentData.push(item);
            chart.update(currentData);
            
            setStatus(`Added ${item.Company}. Total: ${currentData.length}`);
        };
        
        document.getElementById('add5Btn').onclick=()=>{
            if(!all.length) return;
            const itemsToAdd = [];
            for(let i = 0; i < 5 && idx < all.length; i++) {
                itemsToAdd.push(all[idx++]);
            }
            if(itemsToAdd.length > 0) {
                // D3-native update: add multiple items and update chart
                currentData.push(...itemsToAdd);
                chart.update(currentData);
                
                setStatus(`Added ${itemsToAdd.length} companies with staggered animation. Total: ${currentData.length}`);
            }
        };

        document.getElementById('removeBtn').onclick=()=>{
            if(!currentData.length) return;
            const randomIndex = Math.floor(Math.random() * currentData.length);
            const removedItem = currentData[randomIndex];
            
            // D3-native update: remove item from current data and update chart
            currentData.splice(randomIndex, 1);
            chart.update(currentData);
            
            setStatus(`Removed ${removedItem.Company}. Total: ${currentData.length}`);
        };

        document.getElementById('clearBtn').onclick=()=>{
            // D3-native update: clear all data and update chart
            currentData = [];
            chart.update(currentData);
            
            setStatus('Cleared');
        };

        // Add event handling to showcase modern API
        chart.on('change', stats=>{
            console.log('Data changed:', stats);
            setStatus(`Chart updated: ${stats.total} companies (${stats.entered} added, ${stats.exited} removed)`);
        });
        
        // Add bubble interaction events using D3-native API
        chart.on('bubble:click', (data) => {
            const company = data.data;
            const message = `🏢 ${company.Company}\n💰 Revenue: $${company.Revenues_M}M\n🏭 Sector: ${company.Sector}`;
            alert(message);
        });
        
        chart.on('bubble:mouseenter', (data, event) => {
            const element = event.target;
            element.style.strokeWidth = '2px';
            element.style.stroke = '#333';
            element.style.cursor = 'pointer';
        });
        
        chart.on('bubble:mouseleave', (data, event) => {
            const element = event.target;
            element.style.stroke = 'none';
        });

        console.log('🎈 Reactive Bubble Chart Example loaded');
        console.log('✨ Features: Auto-streaming, smooth animations, interactive bubbles');
        console.log('🎯 Click bubbles for company details, use buttons to add/remove data');
    </script>
</body>
</html> 