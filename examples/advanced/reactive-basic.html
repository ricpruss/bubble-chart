<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reactive Bubble Chart - New API</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <!-- no local dataset; will fetch Fortune-1000 CSV dynamically -->
    <script src="../../dist/bubble-chart.min.js"></script>
    <style>
        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f7fa;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #333;
            margin: 0 0 10px 0;
            font-size: 2.5em;
            font-weight: 300;
        }
        
        .header p {
            color: #666;
            font-size: 1.1em;
            margin: 0;
        }
        
        .demo-section {
            margin: 30px 0;
        }
        
        .demo-section h2 {
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        
        .controls {
            display: flex;
            gap: 12px;
            margin: 15px 0;
        }
        
        .controls button {
            background: #667eea;
            color: #fff;
            border: none;
            padding: 8px 14px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85rem;
        }
        
        .controls button:hover {
            background: #5a67d8;
        }
        
        .controls button:active {
            transform: translateY(0);
        }
        
        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            min-height: 400px;
        }
        
        .status {
            margin-top: 10px;
            color: #555;
            font-size: 0.9rem;
        }
        
        .code-example {
            background: #282c34;
            color: #abb2bf;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
            white-space: pre-line;
            overflow-x: auto;
            margin: 15px 0;
        }
        
        .keyword { color: #c678dd; }
        .string { color: #98c379; }
        .comment { color: #5c6370; font-style: italic; }
        
        .info {
            background: #f8f9ff;
            border-left: 4px solid #667eea;
            padding: 20px;
            border-radius: 0 8px 8px 0;
            margin-top: 20px;
        }
        
        .info h3 {
            margin-top: 0;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸŽˆ Reactive Bubble Chart - New API</h1>
            <p>Demonstrating automatic data updates with reactive patterns</p>
        </div>

        <div class="demo-section">
            <h2>Streaming Data Updates</h2>
            
            <div class="controls">
                <button id="addBtn">Add One</button>
                <button id="add5Btn">Add 5</button>
                <button id="removeBtn">Remove</button>
                <button id="clearBtn">Clear All</button>
            </div>
            
            <div id="status" class="status">Initialised.</div>
            
            <div class="chart-container" id="chart"></div>
        </div>

        <div class="demo-section">
            <h2>Code Example</h2>
            
            <div class="code-example">
<span class="comment">// Old API (deprecated - manual data management)</span>
<span class="keyword">const</span> chart = <span class="keyword">new</span> BubbleChart({
    container: <span class="string">'#chart'</span>,
    label: <span class="string">'name'</span>,
    size: <span class="string">'value'</span>
});
chart.data(newData).update(); <span class="comment">// Manual updates, no streaming</span>

<span class="comment">// Modern Fluent API (automatic streaming with smooth animations)</span>
<span class="keyword">const</span> chart = BubbleChart.create(<span class="string">'#chart'</span>)
    .withLabel(<span class="string">'Company'</span>)
    .withSize(<span class="string">'Revenues_M'</span>)
    .withColor(<span class="string">'Sector'</span>)
    .withStreaming({ keyFunction: d => d.Company })
    .render();
    
<span class="comment">// Reactive updates - just add/remove data, animations happen automatically</span>
chart.store.add(newCompany);    <span class="comment">// Smooth entrance animation</span>
chart.store.remove(companyId);  <span class="comment">// Smooth exit animation</span>
            </div>
            
            <div class="info">
                <h3>ðŸ“š Benefits of Streaming Updates</h3>
                <p>
                    â€¢ <strong>Smooth Animations:</strong> New bubbles appear with staggered entrance effects<br>
                    â€¢ <strong>No Screen Clearing:</strong> Updates happen in-place using D3's enter/update/exit pattern<br>
                    â€¢ <strong>Intelligent Layout:</strong> Existing bubbles smoothly transition to new positions<br>
                    â€¢ <strong>Visual Continuity:</strong> Users can track individual bubbles through changes<br>
                    â€¢ <strong>Performance:</strong> Only changed elements are updated, not the entire chart
                </p>
            </div>
        </div>
    </div>

    <script>
        // Create chart using modern fluent API with streaming enabled
        const chart = BubbleChart.create('#chart')
            .withLabel('Company')
            .withSize('Revenues_M')
            .withColor('Sector')  // Color by sector automatically
            .withDimensions(800, 480)
            .withAnimations('gentle')  // Smooth animations for data updates
            .withStreaming({  // Enable streaming with smooth enter/exit animations
                keyFunction: d => d.Company,
                enterAnimation: {
                    duration: 800,
                    staggerDelay: 50,
                    easing: 'ease-out'
                },
                updateAnimation: {
                    duration: 600,
                    easing: 'ease-in-out'
                },
                exitAnimation: {
                    duration: 400,
                    easing: 'ease-in'
                }
            })
            .render();

        // load local JSON dataset generated by fetch-fortune1000.js
        const jsonUrl='../data/fortune1000.json';
        let all=[];
        let idx=0;

        const statusEl=document.getElementById('status');
        const setStatus=msg=>{ if(statusEl) statusEl.textContent=msg; };

        d3.json(jsonUrl).then(dataArr=>{
            all = dataArr;
            setStatus(`Dataset loaded (${all.length} companies). Click Add to stream.`);
        }).catch(err=>{
            console.error('JSON load error',err);
            setStatus('Failed to load dataset');
        });

        document.getElementById('addBtn').onclick=()=>{
            if(!all.length) return;
            if(idx>=all.length) return;
            const item=all[idx++];
            chart.store.add(item);
            setStatus(`Added ${item.Company}. Total: ${chart.store.length()}`);
        };
        
        document.getElementById('add5Btn').onclick=()=>{
            if(!all.length) return;
            const itemsToAdd = [];
            for(let i = 0; i < 5 && idx < all.length; i++) {
                itemsToAdd.push(all[idx++]);
            }
            if(itemsToAdd.length > 0) {
                chart.store.addMany(itemsToAdd);
                setStatus(`Added ${itemsToAdd.length} companies with staggered animation. Total: ${chart.store.length()}`);
            }
        };

        document.getElementById('removeBtn').onclick=()=>{
            if(!chart.store.length()) return;
            const keys=chart.store.keys();
            const key=keys[Math.floor(Math.random()*keys.length)];
            chart.store.remove(key);
            setStatus(`Removed ${key}. Total: ${chart.store.length()}`);
        };

        document.getElementById('clearBtn').onclick=()=>{
            chart.store.clear();
            setStatus('Cleared');
        };

        // Add event handling to showcase modern API
        chart.on('change', stats=>{
            console.log('Data changed:', stats);
            setStatus(`Chart updated: ${stats.total} companies (${stats.entered} added, ${stats.exited} removed)`);
        });
        
        // Add bubble interaction events
        chart.onBubble('click', (company, event) => {
            const message = `ðŸ¢ ${company.Company}\nðŸ’° Revenue: $${company.Revenues_M}M\nðŸ­ Sector: ${company.Sector}`;
            alert(message);
        });
        
        chart.onBubble('mouseenter', (company, event, element) => {
            element.style.strokeWidth = '2px';
            element.style.stroke = '#333';
            element.style.cursor = 'pointer';
        });
        
        chart.onBubble('mouseleave', (company, event, element) => {
            element.style.stroke = 'none';
        });

        console.log('ðŸŽˆ Reactive Bubble Chart Example loaded');
        console.log('âœ¨ Features: Auto-streaming, smooth animations, interactive bubbles');
        console.log('ðŸŽ¯ Click bubbles for company details, use buttons to add/remove data');
    </script>
</body>
</html> 