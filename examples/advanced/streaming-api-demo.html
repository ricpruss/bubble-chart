<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fortune 1000 2024 - Live Company Visualization</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="../js/companies.js"></script>
  <script src="../../dist/bubble-chart.min.js"></script>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:0;padding:20px;background:#f5f7fa}
    .panel{max-width:1400px;margin:0 auto;background:#fff;border-radius:12px;padding:25px;box-shadow:0 8px 25px rgba(0,0,0,.08)}
    h1{font-weight:300;margin:0 0 10px;color:#333;font-size:clamp(1.5rem, 5vw, 2.5rem);}
    .subtitle{color:#666;margin-bottom:20px;font-size:16px}
    .controls{display:flex;flex-wrap:wrap;gap:12px;margin:15px 0;align-items:center}
    .controls button{background:#667eea;color:#fff;border:none;padding:10px 18px;border-radius:6px;cursor:pointer;font-size:clamp(0.75rem, 3vw, 0.9rem);transition:background .2s}
    .controls button:hover{background:#5a67d8}
    .controls input, .controls select{padding:8px 12px;border:2px solid #e2e8f0;border-radius:6px;font-size:clamp(0.75rem, 3vw, 0.9rem);width:120px}
    .size-selector{display:flex;align-items:center;gap:8px}
    #chart{background:#fafafa;border:2px solid #eee;border-radius:10px;min-height:650px;position:relative;padding:10px}
    .status{margin-top:10px;padding:10px 15px;background:#f7fafc;border-left:4px solid #667eea;border-radius:6px;color:#333;font-size:.9rem}
    .tooltip{position:absolute;background:rgba(255,255,255,0.98);border-radius:8px;padding:15px;box-shadow:0 4px 20px rgba(0,0,0,0.15);pointer-events:none;font-size:14px;max-width:320px;border:1px solid #e2e8f0}
    .tooltip h3{margin:0 0 8px;font-size:18px;color:#2d3748;font-weight:600}
    .tooltip .rank{color:#667eea;font-weight:bold;font-size:16px}
    .tooltip p{margin:4px 0;color:#4a5568}
    .tooltip .profit{color:#38a169;font-weight:600}
    .tooltip .ceo{color:#805ad5;font-style:italic}
    .legend{display:flex;flex-wrap:wrap;gap:12px;margin:15px 0;padding:15px;background:#f7fafc;border-radius:8px}
    .legend-item{display:flex;align-items:center;gap:6px;font-size:clamp(0.65rem, 2vw, 13px);padding:4px 8px;background:#fff;border-radius:4px;border:1px solid #e2e8f0}
    .legend-color{width:14px;height:14px;border-radius:3px}
    .stats{display:flex;gap:20px;margin:15px 0;font-size:14px;color:#666}
    .stat{text-align:center}
    .stat-value{font-size:20px;font-weight:bold;color:#333;display:block}
    .badges{display:flex;gap:5px;margin-top:5px}
    .badge{padding:2px 6px;border-radius:3px;font-size:11px;color:#fff}
    .badge.female{background:#e53e3e}
    .badge.founder{background:#38a169}
    .badge.profitable{background:#3182ce}
    /* Mobile optimizations */
    @media (max-width: 768px) {
      body { padding: 10px; }
      .panel {padding: 20px;}
      #chart {min-height: 550px;}
    }
  </style>
</head>
<body>
  <div class="panel">
    <h1>üè¢ Fortune 1000 Companies 2024</h1>
    <p class="subtitle">Interactive visualization of America's largest companies by profits and sector</p>
    
    <div class="stats" id="stats">
      <div class="stat">
        <span class="stat-value" id="stat-companies">1000</span>
        <span>Companies</span>
      </div>
      <div class="stat">
        <span class="stat-value" id="stat-profits">$1.9T</span>
        <span>Total Profits</span>
      </div>
      <div class="stat">
        <span class="stat-value" id="stat-female">9.7%</span>
        <span>Female CEOs</span>
      </div>
      <div class="stat">
        <span class="stat-value" id="stat-founder">6.3%</span>
        <span>Founder CEOs</span>
      </div>
    </div>
    
    <div class="controls">
      <button id="startBtn">Start Stream</button>
      <button id="stopBtn">Stop Stream</button>
      <button id="addBtn">Add Company</button>
      <button id="clearBtn">Clear</button>
      <label>Interval(ms)
        <input type="number" id="intervalInput" value="800" min="300" step="100" />
      </label>
      <div class="size-selector">
        <label for="sizeSelect">Size by:</label>
        <select id="sizeSelect">
          <option value="profits">Profits</option>
          <option value="revenue">Revenue</option>
          <option value="employees">Employees</option>
          <option value="marketCap">Market Cap</option>
          <option value="rank">Fortune Rank</option>
        </select>
      </div>
    </div>
    
    <div id="legend" class="legend"></div>
    <div id="status" class="status">Ready to stream Fortune 1000 companies‚Ä¶</div>
    <div id="chart"></div>
  </div>

  <script>
    // Wait for scripts to load
    window.onload = () => {
      const companiesFlat = window.companiesFlat || window.data;
      const dataStats = window.dataStats;
      const sizeOptions = window.sizeOptions;
      
      // Update stats display
      document.getElementById('stat-companies').textContent = dataStats.totalCompanies;
      document.getElementById('stat-profits').textContent = `$${(dataStats.totalProfits / 1000).toFixed(1)}B`;
      document.getElementById('stat-female').textContent = `${(dataStats.femaleCEOCount / dataStats.totalCompanies * 100).toFixed(1)}%`;
      document.getElementById('stat-founder').textContent = `${(dataStats.founderCEOCount / dataStats.totalCompanies * 100).toFixed(1)}%`;

      // Prepare dataset with current size metric
      let currentSizeOption = 'profits';
      let fullDataset = companiesFlat.map(company => ({
        ...company,
        displaySize: sizeOptions[currentSizeOption].accessor(company)
      }));

      // Create sophisticated color scale by sector with more distinct colors
      const sectors = [...new Set(fullDataset.map(d => d.sector))];
      const colour = d3.scaleOrdinal()
        .domain(sectors)
        .range([
          '#e53e3e', '#3182ce', '#38a169', '#805ad5', '#d69e2e',
          '#dd6b20', '#0bc5ea', '#9f7aea', '#ed8936', '#48bb78',
          '#4299e1', '#ed64a6', '#38b2ac', '#f56565', '#66a3ff',
          '#fbb6ce', '#9ae6b4', '#90cdf4', '#f6ad55', '#fc8181',
          '#a78bfa'
        ]);

      // Create legend
      const legendEl = document.getElementById('legend');
      const updateLegend = () => {
        legendEl.innerHTML = '';
        sectors.forEach(sector => {
          const item = document.createElement('div');
          item.className = 'legend-item';
          item.innerHTML = `
            <div class="legend-color" style="background:${colour(sector)}"></div>
            <span>${sector}</span>
          `;
          legendEl.appendChild(item);
        });
      };
      updateLegend();

      // Create enhanced tooltip
      const tooltip = d3.select('body').append('div')
        .attr('class', 'tooltip')
        .style('opacity', 0);
      
      // Create chart using D3-native streaming API
      const chart = BubbleChart.create('#chart')
        .withLabel('name')
        .withSize('displaySize')
        .withKey(d => d.id) // ‚ú® Key function for D3 data binding - prevents screen clearing!
        .withAnimations({
          enter: {
            duration: 1000,
            stagger: 30,
            easing: 'ease-out'
          },
          update: {
            duration: 800,
            easing: 'ease-in-out'
          },
          exit: {
            duration: 600,
            easing: 'ease-in'
          }
        })
        .withColor(d => colour(d.sector))
        .withResponsive({
          minWidth: 320,
          minHeight: 450,
          maxHeight: 700,
          debounceMs: 200,
          onResize: (dimensions) => {
            console.log('üìè Streaming API Demo chart resized to:', dimensions);
          }
        })
        .build(); // Create empty chart for streaming
        
      // Attach D3-native event handlers
      chart.on('mouseover', (d, event) => {
        tooltip.transition()
          .duration(200)
          .style('opacity', 1);
        
        const badges = [];
        if (d.femaleCEO) badges.push('<span class="badge female">Female CEO</span>');
        if (d.founderIsCEO) badges.push('<span class="badge founder">Founder CEO</span>');
        if (d.profitable) badges.push('<span class="badge profitable">Profitable</span>');
        
        tooltip.html(`
          <h3>${d.name}</h3>
          <p class="rank">Rank #${d.rank}</p>
          <p><strong>Sector:</strong> ${d.sector}</p>
          <p><strong>Industry:</strong> ${d.industry}</p>
          <p class="profit"><strong>Profits:</strong> $${d.profits?.toLocaleString() || 'N/A'}M</p>
          <p><strong>Revenue:</strong> $${d.revenue?.toLocaleString() || 'N/A'}M</p>
          <p><strong>Employees:</strong> ${d.employees?.toLocaleString() || 'N/A'}</p>
          <p class="ceo"><strong>CEO:</strong> ${d.ceo}</p>
          <p><strong>Location:</strong> ${d.city}, ${d.state}</p>
          <div class="badges">${badges.join('')}</div>
        `)
          .style('left', (event.pageX + 15) + 'px')
          .style('top', (event.pageY - 10) + 'px');
      });
      
      chart.on('mouseout', () => {
        tooltip.transition()
          .duration(300)
          .style('opacity', 0);
      });
      
      // Track current dataset for D3-native updates
      let currentData = [];

      // Status helper
      const statusEl = document.getElementById('status');
      const setStatus = (msg) => { statusEl.textContent = msg; };

      // Streaming generator - sort by profits for more interesting visualization
      const sortedDataset = [...fullDataset].sort((a, b) => b.profits - a.profits);
      let idx = 0, timer = null;
      const nextBubble = () => {
        if (idx >= sortedDataset.length) idx = 0;
        return sortedDataset[idx++];
      };

      // Size selector change handler
      document.getElementById('sizeSelect').onchange = (e) => {
        currentSizeOption = e.target.value;
        
        // Update all current bubbles to use the new size metric
        currentData = currentData.map(company => ({
          ...company,
          displaySize: sizeOptions[currentSizeOption].accessor(company)
        }));
        
        // D3-native update: refresh chart with new size metric
        chart.update(currentData);
        
        // Update the sorted dataset for future additions
        fullDataset = companiesFlat.map(company => ({
          ...company,
          displaySize: sizeOptions[currentSizeOption].accessor(company)
        }));
        
        setStatus(`Size metric changed to: ${sizeOptions[currentSizeOption].label}`);
      };

      function startStream() {
        if (timer) return;
        const interval = parseInt(document.getElementById('intervalInput').value) || 800;
        timer = setInterval(() => {
          const company = nextBubble();
          
          // D3-native update: add company to current data and update chart
          currentData.push(company);
          chart.update(currentData);
          
          setStatus(`Added ${company.name} (#${company.rank}) - ${company.sector} - $${company.profits?.toLocaleString() || 'N/A'}M profit`);
        }, interval);
        setStatus('‚è± Streaming companies by profit size‚Ä¶');
      }

      function stopStream() {
        clearInterval(timer);
        timer = null;
        setStatus('‚è∏ Streaming stopped');
      }

      // Event handlers
      document.getElementById('startBtn').onclick = startStream;
      document.getElementById('stopBtn').onclick = stopStream;
      document.getElementById('addBtn').onclick = () => {
        const company = nextBubble();
        
        // D3-native update: add company to current data and update chart
        currentData.push(company);
        chart.update(currentData);
        
        setStatus(`Added ${company.name} (#${company.rank}) - ${company.sector} - $${company.profits?.toLocaleString() || 'N/A'}M profit`);
      };
      document.getElementById('clearBtn').onclick = () => {
        // D3-native update: clear all data and update chart
        currentData = [];
        chart.update(currentData);
        
        idx = 0; // Reset streaming index
        setStatus('Chart cleared - ready to stream again');
      };
    };
  </script>
</body>
</html> 