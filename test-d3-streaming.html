<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>D3-Native Streaming API Test - Motion & Wave Charts</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="dist/bubble-chart.min.js"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f7fa;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    .section {
      background: white;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    h1, h2 {
      color: #2d3748;
      margin-top: 0;
    }
    .controls {
      display: flex;
      gap: 12px;
      margin: 15px 0;
      flex-wrap: wrap;
      align-items: center;
    }
    .controls button {
      background: #667eea;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }
    .controls button:hover {
      background: #5a67d8;
    }
    .controls button:disabled {
      background: #a0aec0;
      cursor: not-allowed;
    }
    .controls input, .controls select {
      padding: 8px 12px;
      border: 1px solid #cbd5e0;
      border-radius: 6px;
      font-size: 14px;
    }
    .chart {
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      min-height: 400px;
      background: #fafafa;
      margin: 15px 0;
    }
    .chart.large {
      min-height: 600px;
    }
    .status {
      background: #f7fafc;
      border-left: 4px solid #667eea;
      padding: 12px 16px;
      margin: 10px 0;
      border-radius: 4px;
      font-size: 14px;
      color: #2d3748;
    }
    .metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 15px 0;
    }
    .metric {
      background: #f7fafc;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }
    .metric-value {
      font-size: 24px;
      font-weight: bold;
      color: #667eea;
      display: block;
    }
    .metric-label {
      font-size: 12px;
      color: #718096;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .log {
      background: #2d3748;
      color: #e2e8f0;
      padding: 12px;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      height: 150px;
      overflow-y: auto;
      margin-top: 10px;
    }
    .error {
      color: #e53e3e;
    }
    .success {
      color: #38a169;
    }
    .warning {
      color: #d69e2e;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="section">
      <h1>🧪 D3-Native Streaming API Test Suite</h1>
      <p>Testing enhanced streaming capabilities for motion and wave charts with the new D3-native fluent API.</p>
      
      <div class="metrics">
        <div class="metric">
          <span class="metric-value" id="total-bubbles">0</span>
          <span class="metric-label">Total Bubbles</span>
        </div>
        <div class="metric">
          <span class="metric-value" id="streaming-rate">0</span>
          <span class="metric-label">Items/sec</span>
        </div>
        <div class="metric">
          <span class="metric-value" id="chart-count">0</span>
          <span class="metric-label">Active Charts</span>
        </div>
        <div class="metric">
          <span class="metric-value" id="test-status">Ready</span>
          <span class="metric-label">Test Status</span>
        </div>
      </div>
    </div>

    <!-- Basic Bubble Chart Test -->
    <div class="section">
      <h2>📊 Basic Bubble Chart - D3 Native API</h2>
      <div class="controls">
        <button id="basic-start">Start Streaming</button>
        <button id="basic-stop">Stop</button>
        <button id="basic-clear">Clear</button>
        <label>Interval: <input type="number" id="basic-interval" value="500" min="100" step="100"> ms</label>
      </div>
      <div class="status" id="basic-status">Ready to test basic bubble chart streaming...</div>
      <div class="chart" id="basic-chart"></div>
    </div>

    <!-- Motion Chart Test -->
    <div class="section">
      <h2>🌊 Motion Bubble Chart - Physics Simulation</h2>
      <div class="controls">
        <button id="motion-start">Start Streaming</button>
        <button id="motion-stop">Stop</button>
        <button id="motion-clear">Clear</button>
        <label>Interval: <input type="number" id="motion-interval" value="800" min="200" step="100"> ms</label>
        <label>Force Strength: <input type="range" id="motion-force" min="0.1" max="2" step="0.1" value="1"> <span id="motion-force-val">1.0</span></label>
      </div>
      <div class="status" id="motion-status">Ready to test motion chart streaming with physics...</div>
      <div class="chart large" id="motion-chart"></div>
    </div>

    <!-- Wave Chart Test -->
    <div class="section">
      <h2>🌊 Wave Bubble Chart - Animated Waves</h2>
      <div class="controls">
        <button id="wave-start">Start Streaming</button>
        <button id="wave-stop">Stop</button>
        <button id="wave-clear">Clear</button>
        <label>Interval: <input type="number" id="wave-interval" value="600" min="200" step="100"> ms</label>
        <label>Wave Speed: <input type="range" id="wave-speed" min="0.5" max="3" step="0.1" value="1"> <span id="wave-speed-val">1.0</span></label>
      </div>
      <div class="status" id="wave-status">Ready to test wave chart streaming...</div>
      <div class="chart large" id="wave-chart"></div>
    </div>

    <!-- Performance Log -->
    <div class="section">
      <h2>📋 Performance & Debug Log</h2>
      <div class="controls">
        <button id="clear-log">Clear Log</button>
        <button id="run-all-tests">Run All Tests</button>
        <button id="stress-test">Stress Test (Fast Streaming)</button>
      </div>
      <div class="log" id="debug-log"></div>
    </div>
  </div>

  <script>
    // Wait for everything to load
    window.onload = () => {
      // Debug logging utility
      const log = (message, type = 'info') => {
        const logEl = document.getElementById('debug-log');
        const timestamp = new Date().toLocaleTimeString();
        const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
        logEl.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
        logEl.scrollTop = logEl.scrollHeight;
        console.log(`[${type.toUpperCase()}] ${message}`);
      };

      // Clear log
      document.getElementById('clear-log').onclick = () => {
        document.getElementById('debug-log').innerHTML = '';
      };

      // Sample data generator
      const generateSampleData = () => {
        const companies = [
          'Apple Inc.', 'Microsoft Corp.', 'Amazon.com Inc.', 'Alphabet Inc.', 'Meta Platforms',
          'Tesla Inc.', 'NVIDIA Corp.', 'Berkshire Hathaway', 'Johnson & Johnson', 'Walmart Inc.',
          'Procter & Gamble', 'JPMorgan Chase', 'UnitedHealth Group', 'Visa Inc.', 'Mastercard Inc.',
          'Home Depot Inc.', 'Walt Disney Co.', 'Nike Inc.', 'Coca-Cola Co.', 'Pfizer Inc.'
        ];
        
        const sectors = ['Technology', 'Healthcare', 'Financial', 'Consumer', 'Energy', 'Industrial'];
        const colors = ['#ff7f0e', '#2ca02c', '#d62728', '#9467bd', '#8c564b', '#e377c2'];
        
        return companies.map((name, i) => ({
          id: `company-${i}`,
          name,
          value: Math.random() * 100 + 10,
          profits: Math.random() * 1000 + 100,
          employees: Math.random() * 50000 + 1000,
          sector: sectors[Math.floor(Math.random() * sectors.length)],
          color: colors[Math.floor(Math.random() * colors.length)],
          percentage: Math.random() * 100, // For wave charts
          timestamp: Date.now() + i * 1000
        }));
      };

      const sampleData = generateSampleData();
      let dataIndex = 0;
      let totalBubbles = 0;
      let activeCharts = 0;

      // Update metrics
      const updateMetrics = () => {
        document.getElementById('total-bubbles').textContent = totalBubbles;
        document.getElementById('chart-count').textContent = activeCharts;
      };

      // Create charts using the new D3-native API
      log('Initializing charts with D3-native fluent API...', 'info');

      try {
        // Basic Bubble Chart - D3 Native API
        log('Creating basic bubble chart...', 'info');
        // 🚀 D3-Native: Chart renders automatically when data is bound!
        const basicChart = BubbleChart.createChart('#basic-chart')
          .withData([])              // ✨ Auto-renders here!
          .withLabel('name')
          .withSize('value')
          .withColor(d => d.color)
          .withDimensions(800, 350)
          .withStreaming({
            keyFunction: d => d.id,
            enterAnimation: {
              duration: 1000,
              staggerDelay: 50,
              easing: 'ease-out'
            },
            updateAnimation: {
              duration: 600,
              easing: 'ease-in-out'
            },
            exitAnimation: {
              duration: 400,
              easing: 'ease-in'
            }
          })
          .build();                  // Returns live chart (already rendered)

        activeCharts++;
        log('✅ Basic chart created successfully', 'success');

        // Motion Chart - D3 Native API
        log('Creating motion bubble chart...', 'info');
        // 🚀 D3-Native: Chart renders automatically when data is bound!
        const motionChart = BubbleChart.createChart('#motion-chart')
          .withData([])              // ✨ Auto-renders here!
          .withType('motion')
          .withLabel('name')
          .withSize('profits')
          .withColor(d => d.color)
          .withDimensions(800, 500)
          .withStreaming({
            keyFunction: d => d.id,
            enterAnimation: {
              duration: 1200,
              staggerDelay: 100,
              easing: 'ease-out'
            },
            updateAnimation: {
              duration: 800,
              easing: 'ease-in-out'
            },
            exitAnimation: {
              duration: 600,
              easing: 'ease-in'
            }
          })
          .build();                  // Returns live chart (already rendered)

        activeCharts++;
        log('✅ Motion chart created successfully', 'success');

        // Wave Chart - D3 Native API
        log('Creating wave bubble chart...', 'info');
        // 🚀 D3-Native: Chart renders automatically when data is bound!
        const waveChart = BubbleChart.createChart('#wave-chart')
          .withData([])              // ✨ Auto-renders here!
          .withType('wave')
          .withLabel('name')
          .withSize('employees')
          .withPercentage(d => d.percentage)
          .withColor(d => d.color)
          .withDimensions(800, 500)
          .withStreaming({
            keyFunction: d => d.id,
            enterAnimation: {
              duration: 1500,
              staggerDelay: 80,
              easing: 'ease-out'
            },
            updateAnimation: {
              duration: 900,
              easing: 'ease-in-out'
            },
            exitAnimation: {
              duration: 500,
              easing: 'ease-in'
            }
          })
          .build();                  // Returns live chart (already rendered)

        activeCharts++;
        log('✅ Wave chart created successfully', 'success');

        updateMetrics();
        document.getElementById('test-status').textContent = 'Ready';

        // Chart-specific streaming controls
        const createStreamingControls = (chart, prefix, statusId) => {
          let timer = null;
          let localIndex = 0;

          const start = () => {
            if (timer) return;
            const interval = parseInt(document.getElementById(`${prefix}-interval`).value) || 500;
            
            timer = setInterval(() => {
              if (localIndex >= sampleData.length) localIndex = 0;
              const item = { ...sampleData[localIndex++], addedAt: Date.now() };
              
              chart.store.add(item);
              totalBubbles++;
              updateMetrics();
              
              document.getElementById(statusId).textContent = 
                `Added: ${item.name} (Total: ${chart.store.data().length})`;
              
              log(`${prefix.toUpperCase()}: Added ${item.name}`, 'info');
            }, interval);
            
            document.getElementById(statusId).textContent = `Streaming at ${interval}ms intervals...`;
            log(`${prefix.toUpperCase()}: Started streaming at ${interval}ms intervals`, 'success');
          };

          const stop = () => {
            if (timer) {
              clearInterval(timer);
              timer = null;
              document.getElementById(statusId).textContent = 'Streaming stopped';
              log(`${prefix.toUpperCase()}: Streaming stopped`, 'warning');
            }
          };

          const clear = () => {
            stop();
            const count = chart.store.data().length;
            chart.store.clear();
            totalBubbles = Math.max(0, totalBubbles - count);
            updateMetrics();
            localIndex = 0;
            document.getElementById(statusId).textContent = 'Chart cleared';
            log(`${prefix.toUpperCase()}: Cleared ${count} items`, 'warning');
          };

          return { start, stop, clear };
        };

        // Setup controls
        const basicControls = createStreamingControls(basicChart, 'basic', 'basic-status');
        const motionControls = createStreamingControls(motionChart, 'motion', 'motion-status');
        const waveControls = createStreamingControls(waveChart, 'wave', 'wave-status');

        // Event listeners
        document.getElementById('basic-start').onclick = basicControls.start;
        document.getElementById('basic-stop').onclick = basicControls.stop;
        document.getElementById('basic-clear').onclick = basicControls.clear;

        document.getElementById('motion-start').onclick = motionControls.start;
        document.getElementById('motion-stop').onclick = motionControls.stop;
        document.getElementById('motion-clear').onclick = motionControls.clear;

        document.getElementById('wave-start').onclick = waveControls.start;
        document.getElementById('wave-stop').onclick = waveControls.stop;
        document.getElementById('wave-clear').onclick = waveControls.clear;

        // Force strength control for motion chart
        document.getElementById('motion-force').oninput = (e) => {
          const value = parseFloat(e.target.value);
          document.getElementById('motion-force-val').textContent = value.toFixed(1);
          log(`Motion force strength set to ${value}`, 'info');
        };

        // Wave speed control
        document.getElementById('wave-speed').oninput = (e) => {
          const value = parseFloat(e.target.value);
          document.getElementById('wave-speed-val').textContent = value.toFixed(1);
          log(`Wave speed set to ${value}`, 'info');
        };

        // Run all tests
        document.getElementById('run-all-tests').onclick = () => {
          log('🚀 Running all tests...', 'info');
          basicControls.start();
          setTimeout(() => motionControls.start(), 2000);
          setTimeout(() => waveControls.start(), 4000);
        };

        // Stress test
        document.getElementById('stress-test').onclick = () => {
          log('⚡ Starting stress test with fast streaming...', 'warning');
          document.getElementById('basic-interval').value = '100';
          document.getElementById('motion-interval').value = '150';
          document.getElementById('wave-interval').value = '200';
          
          basicControls.start();
          motionControls.start();
          waveControls.start();
        };

        log('🎉 All charts initialized successfully! Ready for testing.', 'success');

      } catch (error) {
        log(`❌ Error initializing charts: ${error.message}`, 'error');
        console.error('Chart initialization error:', error);
        document.getElementById('test-status').textContent = 'Error';
      }
    };
  </script>
</body>
</html>
